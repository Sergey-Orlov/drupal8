<?php
use Drupal\gigya\Helper\GigyaHelper;
use Aws\S3\S3Client;
use Aws\S3\Exception\S3Exception;
/**
 * Implements hook_page_attachments().
 * @param array $attachments
 */
function gigya_page_attachments(array &$attachments) {
  //Check for api key.
  $api_key = \Drupal::config('gigya.settings')->get('gigya.gigya_api_key');
  if (!empty($api_key)) {
    //Add gigya params to drupalSettings.
    $global_params = \Drupal::config('gigya.global')->get('gigya.globalParameters');
    \Drupal::moduleHandler()->alter('gigya_global_parameters', $global_params);

    $attachments['#attached']['drupalSettings']['gigya']['globalParameters'] = $global_params;
    $attachments['#attached']['drupalSettings']['gigya']['apiKey'] = \Drupal::config('gigya.settings')->get('gigya.gigya_api_key');
    $attachments['#attached']['drupalSettings']['gigya']['dataCenter'] = \Drupal::config('gigya.settings')->get('gigya.gigya_data_center');

    $lang = \Drupal::config('gigya.global')->get('gigya.language');
    //Check if lang is in auto mode.
    if (strtolower($lang) == 'auto') {
      $lang = \Drupal::languageManager()->getCurrentLanguage()->getId();

      $helper = new GigyaHelper();

      $languages = $helper->getGigyaLanguages();

      if (!array_key_exists($lang, $languages)) {
        //If we do not have the lang in gigya set the lang to the fallback.
        $lang = \Drupal::config('gigya.global')->get('gigya.languageFallback');
      }
    }

    \Drupal::moduleHandler()->alter('gigya_lang', $lang);
    $attachments['#attached']['drupalSettings']['gigya']['lang'] = $lang;

    // Add Library.
    $attachments['#attached']['library'][] = 'gigya/drupalGigya';
  }

  //added for job:
//Check if job enabled
    $jobEnabled = \Drupal::config('gigya.job')->get('gigya.enableJob');
    $attachments['#attached']['drupalSettings']['gigya']['enableJob'] = \Drupal::config('gigya.job')->get('gigya.enableJob');
    if ($jobEnabled) {
        //get jobFrequency
        $attachments['#attached']['drupalSettings']['gigya']['jobFrequency'] = \Drupal::config('gigya.job')->get('gigya.jobFrequency');
        //get emailOnSuccess
        $attachments['#attached']['drupalSettings']['gigya']['emailOnSuccess'] = \Drupal::config('gigya.job')->get('gigya.emailOnSuccess');
        //get emailOnFailure
        $attachments['#attached']['drupalSettings']['gigya']['emailOnFailure'] = \Drupal::config('gigya.job')->get('gigya.emailOnFailure');
        // get storageDetails
        $storageDetails = \Drupal::config('gigya.job')->get('gigya.storageDetails');
        \Drupal::moduleHandler()->alter('storageDetails', $storageDetails);
        $attachments['#attached']['drupalSettings']['gigya']['storageDetails'] = $storageDetails;
        gigya_job_cron();
    }

}

/**
 * Implements hook_cron().
 */

//TBD: make sure all is in sec
function gigya_job_cron() {
    $enableJob = \Drupal::config('gigya.job')->get('gigya.enableJob');
    $counterSucceed = 0;
    $counterFailed = 0;
    if ($enableJob) {
        //update last run
        $jobFrequency = \Drupal::config('gigya.job')->get('gigya.jobFrequency');
        //REQUEST_TIME
        $request_time = \Drupal::time()->getRequestTime();
       // $last_run = \Drupal::state()->get('job.last_run', 0);

        $last_run = 0;

        // If x minutes passed since last time delete the rows/uids
        if (($request_time - $last_run) > 0) {
       //if (($request_time - $last_run) > $jobFrequency) {
            $helper = new GigyaHelper();
            $messageSucceed = "User successfully deleted from CMS - UID: ";
            $files = filesList();
            foreach ($files as $file)
            {
                $storageDetails = \Drupal::config('gigya.job')->get('gigya.storageDetails');
                $key = $file['Key'];
                $objectKeyPrefix = $storageDetails['objectKeyPrefix'];
            //    $f1 = preg_match($storageDetails['objectKeyPrefix'] . '[A-Za-z][0-9]*', $file['Key']);
             //   $f2 = preg_match($storageDetails['objectKeyPrefix'] . '+', $file['Key']);
             //   $f3 = preg_match($storageDetails['objectKeyPrefix'] . '+', $file['Key']);
            //    $f4 = preg_match($storageDetails['objectKeyPrefix'] . '/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[$%^&]).*$/', $file['Key']);
                $f5 = preg_match($storageDetails['objectKeyPrefix'] . '\/.+', $file['Key']);
              //  $f6 = preg_match($file['Key'], $storageDetails['objectKeyPrefix'] . '/');
                if ($file['LastModified'] > $last_run && strpos( $file['Key'], $storageDetails['bucketName'] ) !== false) { // && $file['Key'].contains($storageDetails['bucketName'])
                    $accounts = getUsers($file);

                    //foreach ($accounts as $uid)
                    for ($i = 1; $i < count($accounts); $i++) {

                        if ($user = $helper->getUidByUUID($accounts[$i])) {
                            try {
                                //get CMS's uid by Gigya uid
                                $CMSuid = $user->get('uid')->value;
                                if ($CMSuid == 1) {
                                    \Drupal::logger('gigya')->notice("Skipped deleting admin user");
                                } else {
                                    user_delete($CMSuid);
                                    $counterSucceed++;
                                    \Drupal::logger('gigya')->notice($messageSucceed . $accounts[$i]);
                                }
                            } //or with hook:  hook_user_delete($account)
                            catch (\Exception $e) {
                                //add to logs
                                \Drupal::logger('my_module')->error("Failed to delete UID " . $accounts[$i] . " from CMS with error - " . $e);
                                //increase failed counter to send in email
                                $counterFailed++;
                            }
                        } else {
                            //add to logs
                            \Drupal::logger('my_module')->error("Failed to delete UID: " . $accounts[$i] . ", UID wasn't found in CMS");
                            //increase failed counter to send in email
                            $counterFailed++;
                        }

//                $query = \Drupal::database()->delete('users');
//                $query->condition('uuid == ' . $uid)
//                    ->execute();
                    }
                    if ($counterFailed >= 0) {
                        $total = $counterFailed + $counterSucceed;
                        $message = "CMS delete job failed for " . $counterFailed . "/" . $total;
                        // $params['to'] = \Drupal::config('gigya.job')->get('gigya.storageDetails.emailOnSuccess');
                        $params['to'] = "inbal@gigya-inc.com";
                        $params['message'] = $message;
                        $title = "delete users job";
                         gigya_job_mail('job_email', $message, $params);
                        //  sendEmail($title, $message, 'notice_job', "inbal@gigya-inc.com");
                    }
                    if ($counterSucceed > 0) {
                        //  gigya_job_mail('notice_job', &$message, $params);
                    }
                }



            }
            // Update last run.
            \Drupal::state()->set('job.last_run', $request_time);
        }
    }
}
function filesList()
{
    $storageDetails = \Drupal::config('gigya.job')->get('gigya.storageDetails');

    $bucketName = $storageDetails['bucketName'];
    $accessKey = $storageDetails['accessKey'];
    $secretKey = $storageDetails['secretKey'];
    $objectKeyPrefix = $storageDetails['objectKeyPrefix'];

    $s3Client = S3Client::factory(array(
        'key' => $accessKey,
        'secret' => $secretKey,
        'signature' => 'v4',
        'region' => 'eu-west-2',
    ));
    $response = $s3Client->listObjects(array('Bucket' => $bucketName, 'MaxKeys' => 10, 'Prefix' => $objectKeyPrefix));
    return $files = $response->getPath('Contents');
}

function loadFileFromServer($fileName)
{
    //TBD: religion, try and catch, contains

    $storageDetails = \Drupal::config('gigya.job')->get('gigya.storageDetails');

    $bucketName = $storageDetails['bucketName'];
    $accessKey = $storageDetails['accessKey'];
    $secretKey = $storageDetails['secretKey'];
    $objectKeyPrefix = $storageDetails['objectKeyPrefix'];

    $s3Client = S3Client::factory(array(
        'key' => $accessKey,
        'secret' => $secretKey,
        'signature' => 'v4',
        'region' => 'eu-west-2',
    ));
   // $response = $s3Client->listObjects(array('Bucket' => $bucketName, 'MaxKeys' => 10, 'Prefix' => $objectKeyPrefix));
   // $files = $response->getPath('Contents');

    try {
        $result = $s3Client->getObject(array(
            'Bucket' => $bucketName,
            'Key' => $objectKeyPrefix . "/" . $fileName,
        ));
        $body = $result->get('Body');
        $body->rewind();
        $content = $body->read($result['ContentLength']);
        return $content;
    }
    catch(S3Exception $e) {
        \Drupal::logger('gigya')->error("Failed to get file from S3 server - " . $e);
    }
}
function getUsers($fileName)
{
    $file = loadFileFromServer($fileName);
    if ($file !== null) {
        //file_get_contents(path,include_path,context,start,max_length)

       // $csv2 = array_map('str_getcsv', str_getcsv($file,"\n"));
        $array = array_map("str_getcsv", explode("\n", $file));
        return $array;
    }
}


/**
 * Implements hook_mail().
 */

function gigya_job_mail($key, &$message, $params) {
    $options = array(
        'langcode' => 'en'
    );
    switch ($key) {
        case 'job_email':
            $message = array(
                'id' => "gigya" . _ . $key,
                'module' => "gigya",
                'from' => "cms@gigya-inc.com",
                'body' => array(),
                'subject' => '',
                'to' => "inbal@gigya-inc.com",
                'send' => TRUE,
                'key' => $key,
                'langcode' => 'en',
                'params' =>  array(),
            );
            $headers = array(
                'MIME-Version' => '1.0',
                'Content-Type' => 'text/plain; charset=UTF-8; format=flowed; delsp=yes',
                'Content-Transfer-Encoding' => '8Bit',
                'X-Mailer' => 'Drupal',
            );
//          $system = drupal_mail_system("gigya", $key);
//          $message['result'] = $system->mail($message);

            // $message['from'] = \Drupal::config('system.site')->get('mail');
//          $message['id'] = "gigya" . _ . $key;
//          $message['module'] = "gigya";
//          $message['from'] = "cms@gigya-inc.com";
//          $params['subject'] = t('CMS - delete users job: @title', array('@title' => $params['title']), $options);
//          $params['message'] = 'message is here';
//              //$message['body'][] = Html::escape($params['message']);
//          $message['body'][] = $params['message'];
//          $message['subject'] = $params['subject'];
//          $message['to'] = 'inbal@gigya-inc.com';
            // $message['to'] = $params['to'];
            break;
    }
}
function sendEmail($title, $message, $key, $to) {
    $mailManager = \Drupal::service('plugin.manager.mail');
    $module = 'module-name';
    $params['message'] = $message;
    $params['body'][] = $message;
    $params['subject'] = $title;
    $params['title'] = $title;
    //$langcode = \Drupal::currentUser()->getPreferredLangcode();
    $langcode = 'en';
    $send = true;

    $result = $mailManager->mail($module, $key, $to, $langcode, $params, NULL, $send);
    if ($result['result'] != true) {
        $message = t('There was a problem sending your email notification to @email.', array('@email' => $to));
        drupal_set_message($message, 'error');
        \Drupal::logger('mail-log')->error($message);
        return;
    }

    $message = t('An email notification has been sent to @email ', array('@email' => $to));
    drupal_set_message($message);
    \Drupal::logger('mail-log')->notice($message);
}

